# Pomodoing.site 域名配置指南

## 一、DNS 解析配置

### 1. 登录你的域名服务商（如阿里云、腾讯云、Cloudflare等）

### 2. 添加 A 记录

```
类型: A
主机记录: @
记录值: 124.220.224.91
TTL: 600 秒
```

### 3. 添加 www 记录（可选）

```
类型: A
主机记录: www
记录值: 124.220.224.91
TTL: 600 秒
```

### 4. 等待 DNS 生效（5-10分钟）

可以使用以下命令检查：
```bash
ping pomodoing.site
```

---

## 二、服务器端配置

### 1. 登录服务器

```bash
ssh root@124.220.224.91
```

### 2. 上传 Nginx 配置文件

```bash
# 在本地电脑执行
scp D:/download/frontend/pomodoing.site.conf root@124.220.224.91:/etc/nginx/conf.d/
```

### 3. 测试 Nginx 配置

```bash
# 在服务器上执行
nginx -t
```

### 4. 重启 Nginx

```bash
systemctl reload nginx
```

---

## 三、SSL 证书配置（HTTPS）

### 方式1：使用 Certbot 自动配置（推荐）

```bash
# 1. 安装 certbot
apt update
apt install certbot python3-certbot-nginx -y

# 2. 申请证书（会自动配置 Nginx）
certbot --nginx -d pomodoing.site -d www.pomodoing.site

# 3. 测试自动续期
certbot renew --dry-run
```

### 方式2：使用宝塔面板配置

1. 登录宝塔面板
2. 点击左侧"网站" → 找到 pomodoing.site → 点击"设置"
3. 点击左侧"SSL" → "Let's Encrypt"
4. 勾选域名 pomodoing.site 和 www.pomodoing.site
5. 点击"申请"
6. 申请成功后，开启"强制 HTTPS"

---

## 四、前端文件部署

### 1. 更新 config.js

已将 API 地址改为：
```javascript
BASE_URL: 'https://pomodoing.site/api'
```

### 2. 上传前端文件

```bash
# 上传修改后的 config.js
scp D:/download/frontend/js/config.js root@124.220.224.91:/www/wwwroot/pomodoro-frontend/js/

# 上传整个前端目录（可选，如果有其他更新）
scp -r D:/download/frontend/* root@124.220.224.91:/www/wwwroot/pomodoro-frontend/
```

---

## 五、验证配置

### 1. 访问网站

- HTTP: http://pomodoing.site
- HTTPS: https://pomodoing.site（SSL配置后）

### 2. 检查 API 调用

打开浏览器开发者工具（F12）→ Network 标签页，查看 API 请求是否正常：
- 请求地址应该是 `https://pomodoing.site/api/...`
- 状态码应该是 200 或其他正常响应

### 3. 测试功能

- 注册账号
- 登录账号
- 创建番茄钟
- 查看统计数据
- 单词打卡

---

## 六、常见问题

### 1. 访问域名显示502错误

**原因**：后端服务未启动

**解决**：
```bash
# 检查后端服务
pm2 list

# 如果没有运行，启动后端
cd /path/to/backend
pm2 start server.js --name pomodoro-api
```

### 2. API请求跨域错误

**原因**：后端 CORS 配置问题

**解决**：检查后端代码，确保 CORS 配置允许来自 pomodoing.site 的请求

### 3. SSL 证书申请失败

**可能原因**：
- DNS 未生效
- 80/443 端口未开放
- Nginx 配置错误

**解决**：
```bash
# 检查端口
netstat -tulpn | grep :80
netstat -tulpn | grep :443

# 检查防火墙
ufw status
ufw allow 80
ufw allow 443
```

### 4. 网站无法访问

**检查步骤**：
```bash
# 1. 检查 DNS
ping pomodoing.site

# 2. 检查 Nginx
systemctl status nginx
nginx -t

# 3. 查看错误日志
tail -f /var/log/nginx/pomodoing.site.error.log
```

---

## 七、关键配置说明

### Nginx 反向代理

前端文件由 Nginx 直接提供（位于 `/www/wwwroot/pomodoro-frontend`）

API 请求（`/api/*`）通过 Nginx 反向代理到本地后端服务：
```
https://pomodoing.site/api/*  →  http://127.0.0.1:8080/api/*
```

这样的好处：
1. 统一域名，无需暴露后端端口
2. SSL 终止在 Nginx，后端无需处理 HTTPS
3. 避免跨域问题
4. 便于负载均衡和缓存

---

## 八、部署检查清单

- [ ] DNS 解析已配置
- [ ] DNS 已生效（ping 通）
- [ ] Nginx 配置文件已上传
- [ ] Nginx 配置测试通过
- [ ] Nginx 已重启
- [ ] SSL 证书已申请（可选）
- [ ] 前端文件已上传
- [ ] 后端服务正在运行
- [ ] 网站可以访问
- [ ] API 请求正常
- [ ] 登录注册功能正常

---

## 九、维护命令

### 查看访问日志
```bash
tail -f /var/log/nginx/pomodoing.site.access.log
```

### 查看错误日志
```bash
tail -f /var/log/nginx/pomodoing.site.error.log
```

### 重启服务
```bash
# 重启 Nginx
systemctl reload nginx

# 重启后端
pm2 restart pomodoro-api
```

### SSL 证书续期（自动）
Certbot 会自动续期，也可以手动测试：
```bash
certbot renew --dry-run
```
